#!/usr/bin/perl
use strict;
use warnings;
use LWP::UserAgent;
use HTTP::Request::Common;
use JSON::XS;

my $ua = LWP::UserAgent->new;
$ua->default_header('X-Remedie-Client' => 'CLI');

my @channels = @ARGV ? @ARGV : all_channels($ua);

for my $id (@channels) {
    my $res = $ua->post("http://localhost:10010/rpc/channel/refresh", { id => $id });
    my $data = JSON::XS->new->decode($res->content);
    warn sprintf "%d: %s updated (%d)\n", $id, $data->{channel}{name}, $data->{channel}{unwatched_count};
}

sub all_channels {
    my $ua   = shift;
    my $data = JSON::XS->new->decode($ua->get("http://localhost:10010/rpc/channel/load")->content);
    map $_->{id}, @{$data->{channels}};
}
